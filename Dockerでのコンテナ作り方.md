# Dockerを使って第一原理計算をお手軽に試せる仮想環境を作る

第一原理計算をためしたり、そのデータ処理をしたりするのに、一番適しているのはUbuntuに代表されるLinux環境です。
しかし学部生や修士課程で自前のLinux環境を持っている人は少ないでしょう。
そんなときに使えるのが仮想環境です。
WindowsやMacOS上でLinuxの仮想環境を作る方法にはいくつかあるのですが、
慣れてしまえばDockerが手っ取り早いです。

というわけで、今回はDockerを使って仮想環境を作ってみましょう。

## Dockerインストール

### 公式サイト
https://www.docker.com/
ここから、自分のシステムに沿ったものをダウンロードしてインストールします。
Dockerデスクトップを起動すればチュートリアルが始まるので、それが動くか確認しておきましょう。


## DockerFileを使って必要なもの一式が入ったイメージを構築
LinuxベースのOSにはさまざまなものがありますが、
今回はUbuntuというものを使いたいと思います。
Dockerで動くUbuntuのイメージというのも用意されているのですが、
ただ、素のUbuntuのDockerイメージですとコンパイルとかに必要なものが全く入っていないですし、
上述の公開鍵暗号通信のライブラリも入っていないです。

なので、Ubuntuの最新版をベースに必要なものを予め積み込んだイメージを作ります。
このイメージ作成方法を指定したファイルはDockerFileといいます。
Dockerfileはこのリポジトリに置いてあります。
リポジトリ全体のファイルをダウンロードしたい場合は、以下のように`Code`の部分をクリックして、
ZIPでのダウンロードを選択してください。
![download](https://github.com/eminamitani/DFT_on_Docker/blob/16efb08b2f59ad78bfc77084a2f808567124881f/img/github_download.png)


Step by Stepでどんな画面が出てくるかのスクリーンショットを使った説明は、
`第12回マニュアル.pdf`としてこのリポジトリに置いてあります。
文章でわかりにくい箇所は、マニュアルのPDFや動画を見て確認してみてください。

## イメージの構築
DockerFileを作業用ディレクトリで、Macの場合はターミナル、Windowsの場合はコマンドプロンプトを開きます。
Dockerは`docker`というコマンドで様々な作業をさせることができます。
まず、-t のオプションでimageの名前を決めてビルドします（いろいろなライブラリが搭載されたUbuntuのベースになるものをつくるということです）。
この例では`ubuntu_ssh`というimageを作成します。

```
docker build . -t ubuntu_ssh
```
できてるかは
```
docker image ls
```
で確認してみましょう。

## コンテナの起動

```
docker run -dit --name ubuntu -p 12222:22 ubuntu_ssh
```
のようにしてコンテナ（仮想環境）を起動します。`-dit`はバックグラウンドで実行＆端末からキーボード入出力を受け取ったりするためのオプション類です。
`-p 12222:22`はコンテナのport 22をホスト（自分のPC）のポート12222に連結することを指しています。
仮想のサーバーのポートを、現実のPCのどのポートに結びつけるかを指定していることになります。
今回は使わないのですが、SSH接続などをしたいときにはこのポートを使います。
このコマンドで、さっきビルドしたubuntu_sshのイメージに基づいた、コンテナubuntuが起動します。

上の手順で起動したDockerコンテナを停止するには
```
docker stop ubuntu
```

再び起動するには
```
docker start ubuntu
```
のようなコマンドを使います。


## Quantum-Espresso(q-e)のインストール
q-eはgitを使ってダウンロードしてくるのが最も早いので、上記の方法でssh接続した状態で
```
apt install git
```
を行います。

その後、q-e用のディレクトリを作り、そこでgit cloneを行います。
```
mkdir q-e
cd q-e
git clone https://github.com/QEF/q-e.git .
```
とします。
これでq-eのソースコードが入手できました。
gitでダウンロードしてきたものは、現在進行系で様々な改良が加えられています(=未報告のバグがあるかも)
なので、安定バージョンになるようにgit でcheckoutします。
```
git fetch
git checkout qe-7.2
```
この状態で電子状態計算の部分を担うpw.xをコンパイルしましょう。

```
./configure
make pw
```

## 電子状態計算を試してみる
quantum-espressoのような平面波基底のコードで最適な系というわけではないのだけれども、感覚がわかりやすいので、単純な分子の計算をしてみようと思います。

ベンゼン分子の計算に使うインプットは以下のようなものです。
このインプットは`sample1-benzene`ディレクトリの中のpw.inというファイルに相当します。
```
 &control
    calculation  = 'scf'
    restart_mode = 'from_scratch'
    prefix       = 'benz'
    pseudo_dir   = './'
    outdir       = './'
 /
 &system    
    ibrav     =  1
    celldm(1) = 30
    nat       =  12
    ntyp      =  2
    ecutwfc   = 30.0
    ecutrho   = 240.0
    occupations = 'fixed' 
 /
 &electrons
    diagonalization = 'david'
    mixing_beta     =  0.2 
    conv_thr        =  1.0e-8
 /
ATOMIC_SPECIES
 C   12   C.pbe-rrkjus.UPF
 H    1   H.pbe-rrkjus.UPF
ATOMIC_POSITIONS {bohr}
C     15.628439779     15.000000000  15.00
C     14.309410418     17.284679795  15.00
C     11.671351697     17.284679795  15.00
C     10.352322336     15.000000000  15.00
C     11.671351697     12.715320205  15.00
C     14.309410418     12.715320205  15.00
H     17.675013988     15.000000000  15.00
H     15.333642386     19.057243606  15.00
H     10.647119729     19.057243606  15.00
H      8.305748128     15.000000000  15.00
H     10.647119729     10.942756393  15.00
H     15.333642386     10.942756393  15.00
K_POINTS {gamma}

```

一番最後のブロックはC6H12の分子構造のxyz座標を書いています。
その前の
```
ATOMIC_SPECIES
 C   12   C.pbe-rrkjus.UPF
 H    1   H.pbe-rrkjus.UPF
```
のところの、`C.pbe-rrkjus.UPF`は、計算に使う擬ポテンシャルの種類を指しています。
擬ポテンシャルが何かは次回講義で説明します。

`sample1-benzene`ディレクトリ全体を、コンテナ上にアップロードして、
（方法は、`第12回マニュアル.pdf`を確認してください）
そのディレクトリ内で
```
~/q-e/bin/pw.x -in pw.in
```
とすると計算が開始されます。メモリは1.5GBぐらい消費するので、計算中はPCが重くなるかもしれません。